name: Update MIGU Live Channels

on:
  schedule:
    # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´+8å°æ—¶ï¼‰
    - cron: '0 */2 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:  # ä»£ç å˜æ›´æ—¶è¿è¡Œ
    paths:
      - '**.py'
    branches: [ main, master ]

# -------------------------- ã€æ–°å¢æ ¸å¿ƒã€‘å…¨å±€ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆæ‰€æœ‰æ­¥éª¤ç»§æ‰¿ï¼‰ --------------------------
env:
  # å›½å†…ç¨³å®šå…¬å…±ä»£ç†ï¼ˆäº²æµ‹é€‚é…GitHub Actionsï¼Œç›´æ¥ä½¿ç”¨ï¼‰
  HTTP_PROXY: http://117.143.139.249:8080
  HTTPS_PROXY: http://117.143.139.249:8080
  # å…³é”®ï¼šæ’é™¤GitHubç›¸å…³åŸŸåï¼Œé¿å…æ‹‰å–ä»£ç /æäº¤å˜æ›´èµ°ä»£ç†å¯¼è‡´å¤±è´¥
  NO_PROXY: localhost,127.0.0.1,github.com,api.github.com,*.githubusercontent.com,gitlab.com

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
      # ä¾èµ–å®‰è£…ä¹Ÿèµ°ä»£ç†ï¼ˆç»§æ‰¿å…¨å±€envï¼Œæ— éœ€é¢å¤–é…ç½®ï¼‰

    - name: Run MIGU channel updater
      run: |
        python main.py  # è„šæœ¬æ‰§è¡Œèµ°ä»£ç†ï¼Œè‡ªåŠ¨è¾“å‡ºéªŒè¯æ—¥å¿—
      # ç»§æ‰¿å…¨å±€ä»£ç†ç¯å¢ƒå˜é‡

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        if git diff --quiet HEAD -- migu.m3u migu.txt; then
          echo "No changes detected in output files"
        else
          git add migu.m3u migu.txt
          git commit -m "ğŸ¤– Auto-update: MIGUç›´æ’­æº $(date +'%Y-%m-%d %H:%M')"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
