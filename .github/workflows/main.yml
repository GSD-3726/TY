name: IPTV æ’­æ”¾åˆ—è¡¨è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 */2 * * *'   # æ¯ 2 å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    # å¿…é¡»ç»™äºˆå†™å…¥æƒé™ï¼Œæ‰èƒ½æ¨é€å›ä»“åº“
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆChromium å¿…éœ€ï¼‰
        run: |
          sudo apt update
          sudo apt install -y libatk-bridge2.0-0t64 libgtk-3-0t64 libx11-xcb1 \
            libxcb-dri3-0 libdrm2 libgbm1 libasound2t64

      - name: å®‰è£… Python ä¾èµ–
        run: pip install playwright

      # ========== ğŸš€ ç¼“å­˜ Playwright æµè§ˆå™¨é©±åŠ¨ ==========
      - name: ç¼“å­˜ Playwright æµè§ˆå™¨
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/main.py') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: å®‰è£… Playwright æµè§ˆå™¨é©±åŠ¨
        run: python -m playwright install chromium
        # å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œæ­¤æ­¥éª¤ç¬é—´å®Œæˆ

      - name: è¿è¡Œæå–è„šæœ¬
        run: python main.py

      # ========== ğŸ“¤ å°†ç”Ÿæˆçš„æ–‡ä»¶æäº¤å›ä»“åº“ ==========
      - name: æäº¤å¹¶æ¨é€æ’­æ”¾åˆ—è¡¨
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add iptv_channels.m3u iptv_channels.txt
          # åªæœ‰å½“æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰ commit å’Œ push
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: è‡ªåŠ¨æ›´æ–° IPTV æ’­æ”¾åˆ—è¡¨ [skip ci]"
          git push

      # ========== ğŸ“¦ åŒæ—¶ä¸Šä¼  Artifact ä½œä¸ºå¤‡ä»½ ==========
      - name: ä¸Šä¼ æ’­æ”¾åˆ—è¡¨ï¼ˆArtifactï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: iptv-playlists
          path: |
            iptv_channels.m3u
            iptv_channels.txt
            debug_screenshots/
